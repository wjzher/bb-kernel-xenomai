From e38d5cc4de7ed43d0964fa5eeb617874749e3137 Mon Sep 17 00:00:00 2001
From: efargas <efargas@users.noreply.github.com>
Date: Tue, 15 Sep 2015 21:01:17 +0200
Subject: [PATCH 11/12] PWM period control

Applied patch from https://github.com/avterekhov/bb-pwm/, tested and working on 3.8.13 branch
---
 drivers/pwm/pwm-tiehrpwm.c | 44 ++++++++++++++++++++++++++++++--------------
 1 file changed, 30 insertions(+), 14 deletions(-)

diff --git a/drivers/pwm/pwm-tiehrpwm.c b/drivers/pwm/pwm-tiehrpwm.c
index af6f162..836592d 100644
--- a/drivers/pwm/pwm-tiehrpwm.c
+++ b/drivers/pwm/pwm-tiehrpwm.c
@@ -225,6 +225,7 @@ static int ehrpwm_pwm_config(struct pwm_chip *chip, struct pwm_device *pwm,
 	unsigned long period_cycles, duty_cycles;
 	unsigned short ps_divval, tb_divval;
 	int i, cmp_reg;
+	struct pwm_device *pwm_alter; /* In case period changes */
 
 	if (period_ns > NSEC_PER_SEC)
 		return -ERANGE;
@@ -244,26 +245,41 @@ static int ehrpwm_pwm_config(struct pwm_chip *chip, struct pwm_device *pwm,
 		duty_cycles = (unsigned long)c;
 	}
 
+
 	/*
 	 * Period values should be same for multiple PWM channels as IP uses
-	 * same period register for multiple channels.
+	 * same period register for multiple channels. Check if there is any with
+	 * a different period.
 	 */
-	for (i = 0; i < NUM_PWM_CHANNEL; i++) {
-		if (pc->period_cycles[i] &&
-				(pc->period_cycles[i] != period_cycles)) {
-			/*
-			 * Allow channel to reconfigure period if no other
-			 * channels being configured.
-			 */
-			if (i == pwm->hwpwm)
+	if (pc->period_cycles[pwm->hwpwm] != period_cycles) {
+		for (i = 0; i < NUM_PWM_CHANNEL; i++) {
+			if (pc->period_cycles[i]) {
+				pwm_alter = &chip->pwms[i];
+				if (pwm_alter->duty > period_ns) {
+					dev_err(chip->dev, "Duty is larger than period");
+					return -EINVAL;
+				}
+			}
+		}
+		if (!pc->period_cycles[pwm->hwpwm])
+			pc->period_cycles[pwm->hwpwm] = period_cycles;
+		for (i = 0; i < NUM_PWM_CHANNEL; i++) {
+			if (pc->period_cycles[i])
+				pc->period_cycles[i] = period_cycles;
+		}
+		for (i = 0; i < NUM_PWM_CHANNEL; i++) {
+			if (i == pwm->hwpwm) /* No need to run for itself */
 				continue;
-
-			dev_err(chip->dev, "Period value conflicts with channel %d\n",
-					i);
-			return -EINVAL;
+			if (pc->period_cycles[i]) {
+				pwm_alter = &chip->pwms[i];
+				if (ehrpwm_pwm_config(chip, pwm_alter, pwm_alter->duty, period_ns)) {
+					dev_err(chip->dev, "Something went seriously wrong");
+					return -EINVAL;
+				}
+				pwm_alter->period = period_ns;
+			}
 		}
 	}
-
 	pc->period_cycles[pwm->hwpwm] = period_cycles;
 
 	/* Configure clock prescaler to support Low frequency PWM wave */
-- 
2.5.1

